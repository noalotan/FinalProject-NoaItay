stage('Check IAM Service Account') {
    steps {
        script {
            // Output the current context
            sh "kubectl config current-context"
            
            // List all service accounts in kube-system
            sh "kubectl get serviceaccounts -n kube-system"
    
            // Check if the service account exists
            def exists = sh(script: "kubectl get serviceaccount aws-load-balancer-controller -n kube-system --ignore-not-found", returnStatus: true)
            echo "Service account check returned: ${exists}" // Debugging line
            if (exists != 0) {
                echo "IAM Service Account not found. Creating..."
                sh """
                eksctl create iamserviceaccount \\
                  --cluster=${CLUSTER_NAME} \\
                  --region ${REGION_NAME} \\
                  --namespace=kube-system \\
                  --name=aws-load-balancer-controller \\
                  --role-name AmazonEKSLoadBalancerControllerRole \\
                  --attach-policy-arn=${POLICY_ARN} \\
                  --approve
                """
            } else {
                echo "IAM Service Account already exists, skipping creation."
            }
        }
    }
}
