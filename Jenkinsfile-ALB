pipeline {
    agent any 

    environment {
        CLUSTER_NAME = 'cluster-noa-itay'
        REGION_NAME = 'us-east-1'
        POLICY_ARN = 'arn:aws:iam::992382545251:policy/AWSLoadBalancerControllerIAMPolicy'
    }

    stages {
        stage('Setup AWS Credentials') {
            steps {
                withCredentials([aws(credentialsId: 'aws credentials')]) {
                    script {
                        env.AWS_ACCESS_KEY_ID = "${AWS_ACCESS_KEY_ID}"
                        env.AWS_SECRET_ACCESS_KEY = "${AWS_SECRET_ACCESS_KEY}"
                    }
                }
            }
        }

        stage('Update Kubeconfig') {
            steps {
                script {
                    sh """
                    aws eks update-kubeconfig --name ${CLUSTER_NAME} --region ${REGION_NAME}
                    """
                }
            }
        }

        stage('Check IAM Service Account') {
            steps {
                script {
                    // Output the current context
                    sh "kubectl config current-context"
                    
                    // List all service accounts in kube-system
                    sh "kubectl get serviceaccounts -n kube-system"
            
                    // Check if the service account exists
                    def exists = sh(script: "kubectl get serviceaccount aws-load-balancer-controller -n kube-system --ignore-not-found", returnStatus: true)
                    echo "Service account check returned: ${exists}" // Debugging line
                    if (exists != 0) {
                        echo "IAM Service Account not found. Creating..."
                        sh """
                        eksctl create iamserviceaccount \\
                          --cluster=${CLUSTER_NAME} \\
                          --region ${REGION_NAME} \\
                          --namespace=kube-system \\
                          --name=aws-load-balancer-controller \\
                          --role-name AmazonEKSLoadBalancerControllerRole \\
                          --attach-policy-arn=${POLICY_ARN} \\
                          --approve
                        """
                    } else {
                        echo "IAM Service Account already exists, skipping creation."
                    }
                }
            }
        }

        stage('Install AWS Load Balancer Controller') {
            steps {
                script {
                    def installed = sh(script: "helm list -n kube-system | grep aws-load-balancer-controller", returnStatus: true)
                    if (installed != 0) {
                        echo "Installing AWS Load Balancer Controller..."
                        sh """
                        helm repo add eks https://aws.github.io/eks-charts
                        helm repo update eks
                        helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\
                          -n kube-system \\
                          --set clusterName=${CLUSTER_NAME} \\
                          --set serviceAccount.create=false \\
                          --set serviceAccount.name=aws-load-balancer-controller
                        """
                    } else {
                        echo "AWS Load Balancer Controller already installed, skipping installation."
                    }
                }
            }
        }

        stage('Apply Ingress Resources') {
            steps {
                script {
                    // Check if ingress resources exist before applying
                    def ingressExists = sh(script: "kubectl get ingress -n status-page --ignore-not-found", returnStatus: true)
                    if (ingressExists == 1) {
                        echo "Applying ingress resources..."
                        sh """
                        kubectl apply -f ingress/ingress-class.yaml
                        kubectl apply -f ingress/ingress.yaml
                        """
                    } else {
                        echo "Ingress resources already exist, skipping application."
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
}
